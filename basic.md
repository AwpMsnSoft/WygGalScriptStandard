# \!version \"0\.1\.0\"

# 基本规定   

本标准草案中的指代不使用双引号，补充说明使用圆括号（），分行说明使用分号；。

## wgs的文件名：   

wgs脚本的文件名以\.wgs结尾，即扩展名为\.wgs。

## 引擎、解释器和通信  

- 解释器：负责接收引擎发出的脚本、信号，执行脚本中的语句，并将执行结果等信息发送给引擎。解释器既可以是客户端，又可以是服务端。    
- 引擎：负责界面显示，资源获取、加载，文件格式转换，向解释器发送脚本和指挥信号。
- 通信：引擎和解释器之间应采用同步半双工方式通信，具体方式取决于实现。通信断开属于关键错误。

## 编码：   

- 建议使用UTF\-8或UTF\-16LE编码，以防止乱码。
- 为保证脚本能够被解释器正常识别，由引擎对脚本进行编码转换后发送给解释器。

## 脚本文件读取：   

- 脚本可以在运行前读取，也可在运行过程中读取，由引擎负责；
- 运行过程中，任何相关脚本文件内容不应发生变化；
- 运行过程中，脚本文件内容发生变化，或增加/删除脚本文件，均为未定义行为；
- 脚本文件无法读取属于关键错误。

## 未定义行为：   

- 脚本中未规定具体结果的行为是未定义行为，未定义行为的结果依赖脚本解释器和引擎的具体实现；
- 脚本在调试模式下执行时，发现未定义行为应给出警告；
- 脚本在非调试模式下执行时，可根据具体情况决定是否给出警告；
- 除非特别说明，未定义行为不视为关键错误。

## 关键错误：

- 本标准规定的导致引擎或解释器不能继续运行的问题为关键错误；
- 脚本解释器执行到关键错误处时必须终止执行，并将结果反馈给引擎。对于服务端解释器，应恢复到初始状态。
- 除非特别说明，引擎读取、解释器预处理脚本时，发现关键错误不进行处理，只给出警告。

## 执行

- 脚本的执行以行为单元；
- 一行中的不同关键字用一个或多个空格和Tab分隔；
- 行首和行尾允许存在一个或多个空格和Tab，如果存在，这些空格和Tab在读入后被修剪;

## 非文本字符的通用规则：

- 大写英文字母和小写英文字母通用。
- \. 。  半角点号、全角句号2种句点通用；
- \" “ ”  直双引号、左双引号、右双引号3种双引号通用；
- \(（   半角左圆括号、全角左圆括号2种左圆括号通用；
- \)  ）  半角右圆括号、全角右圆括号2种右圆括号通用。

##### 表示文本的字符串，即""内的字符，不通用。

## 数据类型：
数据类型有3种，布尔（真假）、数（实数）、文本（字符串）。

### 布尔（Boolean）：

- 布尔类型用于表示真假，只存在真（True）、假（False）两个值；
- 布尔类型非真即假，非假即真。

### 数（Number）：
- 数可以是整数或小数形式的，在脚本中必须用十进制表示，除了小数点和正负符号外，不能含有其他符号；
- 正负符号用+、-表示，正号默认省略；
- 小数点使用.表示；
- 数据精度不低于IEEE754标准规定的双精度浮点数（即float64 或 double）；
- 数可以比较大小，具有误差，误差必须为小于0.5的非负数，且必须可用IEEE754标准规定的双精度浮点数精确表示，默认的误差是1\/1048576，两个数差的绝对值小于误差时视为等于；
- 设置不能够用IEEE754标准的双精度浮点数精确表示的误差，是影响极小的未定义行为，结果极小概率不同；
- 设置大于等于0\.5的误差或负数误差，是未定义行为；
- 有各种取整指令对数进行取整，详见取整指令。

### 文本（Text \/ String）：
- 文本类型表示一段文本，也叫字符串，在脚本中表示时，必须放在一对双引号内，对应的实际文本没有两端的双引号（例如：\"abc\"表示文本abc）；
- 在脚本中表示的文本内，可以使用\\和\^对文本进行转义；
- 在脚本中表示的文本可以不含任何字符，长度为0，在脚本中用\"\"表示；
- 在脚本中表示的文本，不以双引号开头是未定义行为；以双引号开头的文本不以未被转义的双引号结尾，是关键错误。

#### 转义字符：
- 在脚本\"\"内表示的文本中，未被转义的\\及其后一个相邻字符为转义字符，用于表示脚本文本中无法直接表示或难以分辨的字符；
  - \\n表示换行；
  - \\t表示Tab；
  - \\s表示空格；
  - \\\\表示\\；
  - \\\^表示\^；	 
  - \\\"表示\"；
  - \\“表示“；
  - \\”表示”；
- 转义字符中\右侧的相邻字符为其他字符，是未定义行为；
- 未被转义的\右侧没有字符，是关键错误。

#### 转义文本：
- 在脚本\"\"内表示的文本中，未被转义的\^及其后一个\^之间的部分（包括两端的\^）为转义文本；
- 转义文本去除两端的\^后，和实际文本一致，即其中的\\不用于转义，双引号也不表示文本的结束；
- 转义文本为\^\^时，对应的实际文本不包含任何字符，长度为0；
- 未被转义的\^之后的部分中没有\^，是关键错误。

#### 举例:
\"\\\^awpsoft：\^\"学院派都是瓜。\\n\"\\\^\\n\\\^msneko：\\\"实用主义者都是无头苍蝇\\\^。\\t\\\\n\^\"\^\^\^\" 
表示的实际文本为：

\^awpsoft：\"学院派都是瓜。\\n\"\\   
\^msneko：\"实用主义者都是无头苍蝇\^。	\\n\"

上述文本表示中，转义内容依次为：
\\\^（转义字符）/\^ "学院派都是瓜。\\n"\\\^（ 转义文本）、\\n（转义字符）、\\\^（转义字符）、\\"（转义字符）、\\\^（转义字符）、\\t （转义字符）、\\\\（转义字符）、\^"\^（转义文本）、\^\^（转义文本）。

## 自动类型转换：
- 自动类型转换是一种临时（Temporary）转换；
- 如果某个操作需要Number，但是提供Boolean，则Boolean可表示Number，True表示1，False表示0；
- 如果某个操作需要Text，但是提供Boolean，则Boolean可表示Text，True表示\"True\"，False表示\"False\"；
- 如果某个操作需要Text，但是提供Number，则Number可表示Text，为对应数值的十进制文本，且在表示时会先在以误差为半径的邻域内取值，使整个文本尽可能短，但是绝对值小于1的小数不省略小数点前面的0；如果有多个取值可使文本长度最短，取距离原数最近的值，接下来如果仍然有两个可取值，取绝对值较小的一个值。

### 不允许的自动类型转换：
- 发生了不允许的自动类型转换是关键错误：
  - 需要Boolean，但是提供Number；
  - 需要Boolean，但是提供Text；
  - 需要Number，但是提供Text。

#### 要强制转换，需要使用比较或指令，详见比较和转换指令。 

## 基本运算符：
- 基本运算符是用于对数据进行运算获得结果数据的符号，包括
算术运算符（ \+ 、\- 、\* 、\/ 、\\ 、\% ）、布尔运算符（ \& 、\| 、\~或\! 、\^ ）、比较运算符（ \> 、\< 、 \>\= 、\<\= 、 \= 或 \=\=、 \<\> 或 \!\= ）、文本连接运算符（ \+ ）；
- 不包括位运算符等其他运算符，使用其他运算符为未定义行为。
- 半角\!和全角！不通用，使用全角！为关键错误。

### 运算符功能表:
|形式|A的类型|B的类型|结果类型|说明|中文说明|
|----|----|----|----|----|----|				
|A\+B|Number|Number|Number|Addition|加法|
|A\+B|Text|Text|Text|Connection|连接|
|A\-B|Number|Number|Number|Subtraction|减法|
|A\*B|Number|Number|Number|Multiplication|乘法|
|A/B|Number|Number|Number|Division|除法|
|A\\B|Number|Number|Number|Integer part of (A/B)|除法取整|
|A\%B|Number|Number|Number|A-(B*(B\A))|余数|
|A\&B|Boolean|Boolean|Boolean|And|与|
|A\|B|Boolean|Boolean|Boolean|Or|或|
|A\^B|Boolean|Boolean|Boolean|Xor|异或|
|\~A|Boolean||Boolean|Not|非|
|\!A|Boolean||Boolean|Not|非|
|A\>B|Number|Number|Boolean|More than|大于|
|A\>\=B|Number|Number|Boolean|More than or equals|大于等于|   
|A\<B|Number|Number|Boolean|Less than|小于|
|A\<\=B|Number|Number|Boolean|Less than or equals|小于等于|
|A\=B|Boolean|Boolean|Boolean|Equals|等于|
|A\=\=B|Boolean|Boolean|Boolean|Equals|等于|
|A\<\>B|Boolean|Boolean|Boolean|Not equals|不等于|
|A\!\=B|Boolean|Boolean|Boolean|Not equals|不等于|
|A\=B|Number|Number|Boolean|Equals|等于|
|A\=\=B|Number|Number|Boolean|Equals|等于|
|A\<\>B|Number|Number|Boolean|Not equals|不等于|
|A\!\=B|Number|Number|Boolean|Not equals|不等于|
|A\=B|Text|Text|Boolean|Equals|等于|
|A\=\=B|Text|Text|Boolean|Equals|等于|
|A\<\>B|Text|Text|Boolean|Not equals|不等于|
|A\!\=B|Text|Text|Boolean|Not equals|不等于|

- 使用基本运算符时，形式不符合上表是关键错误；
- 使用基本运算符时，类型不符合上表会发生自动类型转换，发生了不允许的自动类型转换是关键错误。


# 后面的待肃反，包括字符转移的问题：
## 表达式：


### 运算优先级表： 



有效行（Valid Line）
脚本中只有满足下列格式的行才视为有效行，否则为无效行：
.command 		（无参数或省略参数的标准指令）
.command  parameters  	分隔符为至少一个空格或Tab（有参数标准指令）
.~command 		（无参数或省略参数的非标准指令）
.~command  parameters 	分隔符为至少一个空格或Tab（有参数非标准指令）
$var = expression		分隔符为第一个=（赋值语句）	
#label			（标签）
#start			（入口点标签，一个脚本文件只能有一个，有多个入口点为关键错误）
#!pragma			（杂注）
#!pragma  comment		分隔符为至少一个空格或Tab（杂注）

保留的关键错误行：
$var += expression		分隔符为唯一的+=（$var = $var + expression）	
$var -= expression		分隔符为唯一的-=（$var = $var - expression）	
$var *= expression		分隔符为唯一的*=（$var = $var * expression）
$var /= expression		分隔符为唯一的/=（（$var = $var / expression）	
$var \= expression		分隔符为唯一的\=（$var = $var \ expression）	
$var %= expression		分隔符为唯一的%=（$var = $var % expression）
$var &= expression		分隔符为唯一的&=（$var = $var & expression）
$var |= expression		分隔符为唯一的|=（$var = $var | expression）
$var ^= expression		分隔符为唯一的^=（$var = $var ^ expression）
$var++			（$var = $var + 1）
$var--			（$var = $var -  1）	
















